{% extends 'dash.html' %}

{% block title %}订单{% endblock %}


{% block content %}
<div id="app">
    输入Cookie：<input type="search" v-model='cookie' placeholder="设置cookie"><br>
    订单页数：<input type="number" v-model='pageNum' placeholder="设置页数"><br>
    订单数量：<input type="number" v-model='page_size' placeholder="设置页数"><br>
    标记的备注：<input type="text" v-model.trim='memo'><br>
    <ul v-for="c in shop_cookies">
        <li>
            <span v-if="c.updated_at">
                <span v-text="to_time_str(c.updated_at)"></span>
            </span>
            <button class="btn btn-danger" @click='change_cookie(c.cookie_str)'>换${ filterShop(c.id) }cookie</button>
        </li>
        
    </ul>
    <br>
    店铺id：<span v-text='re_shop_id'></span><br>
    <button class="btn btn-primary" @click='post_trades'>开始</button>
    <button class="btn btn-success" @click='init'>更新</button>
    <button class="btn btn-success" @click='all_refresh'>获取全部</button>
    <span @click="reset">重置</span>
    <button class="btn btn-danger" @click='kd("")'>清空</button>
    <button @click='kd("纸票")'>纸票</button>
    <button @click='kd("发票")'>发票</button>
    <button @click='kd("专票")'>专票</button>
    <button @click='kd("收据")'>收据</button>
    <input type="search" class="form-control mt-3 mb-3" placeholder="筛选" v-model="search" autofocus>
    去掉空格<input type="text" v-model='blank'>
    ${ fp }
    <table class="table">
        <thead>
            <tr>
                <th v-for='h in heads'>${ h }</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for='t in filterItems'>
                <td class='td'>${ t.nick }</td>
                <td class='td'>${ t.price }</td>
                <td class='td'>${ filterShop(t.shop) }</td>
                <td>${ t.status }</td>
                <td>
                    <div class="btn-group">
                        <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            更多
                        </button>
                        <div class="dropdown-menu">
                            <span class="dropdown-item" href="#">${ t.id }</span>
                            <span class="dropdown-item" href="#">${ t.createTime }</span><br>
                            <span class="dropdown-item" href="#">${ t.flag }</span>
                        </div>
                    </div>
                </td>
                <td v-html="t.mark">
                </td>
                <td class='td'>${ t.msg }</td>
            </tr>
        </tbody>
    </table>
</div>
<script src="../static/js/moment-with-locales.js"></script>

<script>
    var app = new Vue({
        el: '#app',
        delimiters: ['${','}'],
        data: {
            trades: [],
            shop_cookies: [],
            search: '',
            cookie: '',
            memo: '',
            pageNum: 1,
            page_size: 1000,
            blank: '',
            selected: '3079394145',
            os: [
                { text: 'One', value: '3079394145' },
                { text: 'Two', value: '2933051711' },
                { text: 'Three', value: '925025092' }
            ],
            heads: ['旺旺', '价格', '店铺', '状态', '更多', '备注', '留言',],
            fields: ['nick', 'id', 'flag', 'price', 'shop', 'status', 'mark', 'msg', 'createTime'],
        },
        computed: {
            parse_cookie () {
                return this.cookie.substring(0,8)=="cookie: "?this.cookie.split("cookie: ")[1]:this.cookie;
            },
            re_shop_id () {
                if (this.cookie!='') {
                    var re = /x=(\w+)/;
                    var a = re.exec(this.cookie);
                    var shop_id = a[1]
                    if (shop_id === '3079394145') {
                        return '通众旗舰店'+a[1]
                    } else if (shop_id == '2933051711') {
                        return '亿维办公旗舰店'+a[1]
                    } else if (shop_id == '925025092') {
                        return '亿维通众专卖店'+a[1]
                    } else if (shop_id == '2829884134') {
                        return '众泰专营店'+a[1]
                    } else if (shop_id == '1584616501') {
                        return '易加'+a[1]
                    }
                    
                } else {
                    return ''
                }
            },
            filterItems () {
                return this.trades.filter((item) => {
                    var self = this
                    function fi(key) {
                        return item[key].toLowerCase().match(self.search.toLowerCase())
                    }
                    return fi('id') || fi('price') || fi('nick') || fi('createTime') || fi('msg') || fi('shop') || fi('mark');
                });
            },
            filterShopid (){
                return this.trades.filter((item) => {
                    return item.shop == this.selected;
                });
            },
            filterFapiao () {
                return this.trades.filter((item) => {
                    return item['mark'].match('纸票') || item['msg'].match('票')
                });
            },
            fp () {
                return this.blank.replace(/\s*/g,"")
            }
        },
        created () {
            this.init();
            this.search = '纸票'
        },
        methods: {
            init () {
                if (!localStorage.getItem('cookie')) localStorage.setItem('cookie', '');
                this.cookie = localStorage.getItem('cookie');
                url = '/api/fapiaos'
                fetch(url+ '?page_size=' + this.page_size)
                .then(resp => resp.json())
                .then(data => {
                    this.trades = data.trades;
                    this.shop_cookies = data.shop_cookies;
                    console.log(this.trades)
                })
            },
            post_trades () {
                localStorage.setItem('cookie', this.cookie);
                var data = {'cookie': this.parse_cookie, 'pageNum': this.pageNum}
                var url = '/api/fapiaos'
                fetch(url, {
                    method: 'POST', // or 'PUT'
                    body: JSON.stringify(data), // data can be `string` or {object}!
                    headers: new Headers({
                        'Content-Type': 'application/json'
                    })
                    }).then(res => res.json())
                    .catch(error => console.log('Error:', error))
                    .then(response => {
                        console.log('Success:', response);
                        this.init();
                    });
                
            },
            filterFlag (flag) {
                var flags = [
                    (0, '灰色'), (1, '红色'),(2, '黄色'),(3, '绿色'),(4, '蓝色'),(5, '紫色')
                ]
                return flags[flag]
            },
            filterShop (shop_id) {
                if (shop_id === '3079394145') {
                    return '通众旗舰店'
                } else if (shop_id == '2933051711') {
                    return '亿维办公旗舰店'
                } else if (shop_id == '925025092') {
                    return '亿维通众专卖店'
                } else if (shop_id == '2829884134') {
                    return '众泰专营店'
                } else if (shop_id == '1584616501') {
                    return '易加'
                }
            },
            reset () {
                this.cookie = '';
            },
            kd(kd) {
                this.search = kd
            },
            change_cookie (cookie) {
                this.cookie = cookie
            },
            to_time_str (t) {
                return moment(t*1000).format('YYYY-MM-DD HH:mm:ss')
            },
            all_refresh () {
                var cs = app.shop_cookies;
                for (var i=0;i<cs.length;i++) {
                    console.log(i, cs[i].cookie_str)
                    this.cookie = cs[i].cookie_str
                    setTimeout(function () {console.log('get trade ' + String(i))}, 2000)
                    app.post_trades()
                }
            }
        }
    })
    
    // $(function() {
    //     setInterval(function () {
    //         app.post_trades();
    //         console.log('sleep 2 seconds')
    //     } , 1000*60*28)
    // })
</script>
{% endblock %}

{% block footer %}
{% endblock %}
