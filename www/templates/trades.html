{% extends 'dash.html' %}

{% block title %}紫色{% endblock %}

{% block beforehead %}
    <style>
        body {
            background-color: pink;
        }

        .point {
            background-color: #CCE8CF;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            display: inline-block;
        }

        .read {
            background-color: #CCE8CF;
        }

        .green {
            background-color: green;
        }

        .blue {
            background-color: lightblue;
        }

        .point:hover {
            background: #000;
        }
    </style>
    
    <script>
        function changeBackgroundColor(cl, color) {
            $(cl).click(function () {
                $('body').css('background', color)
                localStorage.setItem('color', color)
            })
        }
        $(function () {
            var color = localStorage.getItem('color');
            $('body').css('background', color);
            changeBackgroundColor('.pink', 'pink');
            changeBackgroundColor('.read', '#CCE8CF')
            changeBackgroundColor('.green', 'yellowgreen')
            changeBackgroundColor('.blue', 'lightblue')
        })
    </script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="../static/js/moment-with-locales.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>

{% endblock %}

{% block content %}
    <div class="point pink"></div>
    <div class="point read"></div>
    <div class="point green"></div>
    <div class="point blue"></div>
    <div id="app">
        输入Cookie：<input type="search" v-model.trim='cookie' placeholder="设置cookie">
        <button @click="reset1()">重置</button><br>
        订单页数：<input type="number" v-model.trim='pageNum' placeholder="设置页数">
        <div class="block">
          <div class="block">
            <span class="demonstration">成交时间: </span>
            <el-date-picker
              v-model="value"
              type="datetimerange"
              :picker-options="pickerOptions"
              range-separator="至"
              start-placeholder="开始日期"
              end-placeholder="结束日期"
              align="right">
            </el-date-picker>
          </div>
        订单数量：<input type="number" v-model='page_size' placeholder="设置页数">
        <br>
        网名：<textarea v-model.trim='names' name='text' id="" cols="30" rows="10"></textarea>
        <button @click='clear' id='btn1'>换名</button>
        <button @click='clear2' id='btn2'>换回来</button>
        网名第二天：<textarea v-model.trim='names2' name='text' cols="30" rows="10"></textarea>
        <br>
        店铺id：<span v-text='re_shop_id'></span><br>
        <button class="btn btn-primary" @click='post_trades'>开始</button>
        <button class="btn btn-success" @click='init'>更新</button>
        <button @click="reset()">重置</button>
        <button @click='kd("关闭")'>关闭</button>
        <button @click='kd("申通")'>申通</button>
        <button @click='kd("韵达")'>韵达</button>
        <button @click='kd("百世")'>百世</button>
        <button @click='kd("顺丰")'>顺丰</button>
        <button @click='kd("邮政")'>邮政</button>
        <button @click='kd("2933051711")'>亿维办公</button>
        <button @click='kd("925025092")'>亿维专卖店</button>
        <button @click='kd("3079394145")'>通众旗舰店</button>
        <button @click='kd("1584616501")'>易加</button>
        <input type="search" class="form-control mt-3 mb-3" placeholder="筛选" v-model.trim="search">
        <button class="btn btn-danger" @click='kd("")'>清空</button>
        <div class="table-responsive">
            <table class="table ">
                <thead>
                    <tr>
                        <th v-for='h in heads'>${ h }</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for='t in filterItems'>
                        <td><span @click='kd(t.nick)'>${ t.nick }</span></td>
                        <td>
                            <a :href="'https://trade.tmall.com/detail/orderDetail.htm?bizOrderId='+t.id" target="blank">${ t.id }</a></td>
                        <td>
                            <span v-if="t.flag==5" style="color: purple">${ t.flag }</span>
                            <span v-else>${ t.flag }</span>
                        </td>
                        <td>${ t.price }</td>
                        <td>
                            <span v-if="t.wuliu=='物流公司：申通快递 '">
                                <a :href="'https://wuliu.taobao.com/user/order_detail_new.htm?trade_id=' + t.id + '&seller_id=' + t.shop" target="blank">
                                    ${ t.wuliu }
                                </a>
                            </span>
                            <span v-else style="background: red">
                                <a :href="'https://wuliu.taobao.com/user/order_detail_new.htm?trade_id=' + t.id + '&seller_id=' + t.shop" target="blank">
                                ${ t.wuliu }
                            </a></span>
                        </td>
                        <td>${ filterShop(t.shop) }</td>
                        <td>
                            <span v-if="t.status=='交易关闭'" style="background: red">${ t.status }</span>
                            <span v-else>${ t.status }</span>
                        </td>
                        <td>${ t.createTime }</td>
                        <td>
                            <button class="btn btn-danger btn-sm" @click="del_trade(t)">删除</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>


    <script>
        function startEnd(picker, day, endDay=0) {
            const end = moment().subtract(endDay, 'days');
            const start = moment().subtract(day, 'days')
            picker.$emit('pick', [start, end]);
        }
        const end = new Date();
        const start = new Date();
        var app = new Vue({
            el: '#app',
            delimiters: ['${','}'],
            data: {
                trades: [],
                search: '',
                names: '',
                names2: '',
                name3: '',
                cookie: '',
                test: '',
                pageNum: 1,
                page_size: 200,
                fields: ['nick', 'id', 'flag', 'price', 'wuliu', 'shop', 'status', 'createTime'],
                heads: ['旺旺', '订单号', '旗子', '价格', '物流', '店铺', '交易状态', '交易时间', '操作'],
                pickerOptions: {
                    shortcuts: [
                    {
                        text: '最近一天',
                            onClick(picker) {
                                startEnd(picker, 1);
                            }
                        },{
                        text: '最近二天',
                            onClick(picker) {
                                startEnd(picker, 2);
                            }
                        },{
                            text: '最近一周',
                            onClick(picker) {
                                startEnd(picker, 7);
                            }
                        }, {
                            text: '最近一个月',
                            onClick(picker) {
                                startEnd(picker, 30);
                            }
                        }
                    ]
                },
                value: [moment().subtract(2, 'days'), moment()],
            },
            computed: {
                parse_cookie () {
                    return this.cookie.substring(0,8)=="cookie: "?this.cookie.split("cookie: ")[1]:this.cookie;
                },
                re_shop_id () {
                    if (this.cookie!='') {
                        var re = /x=(\w+)/;
                        var a = re.exec(this.cookie);
                        var shop_id = a[1]
                        if (shop_id === '3079394145') {
                            return '通众旗舰店'+a[1]
                        } else if (shop_id == '2933051711') {
                            return '亿维办公旗舰店'+a[1]
                        } else if (shop_id == '925025092') {
                            return '亿维通众专卖店'+a[1]
                        } else if (shop_id == '2829884134') {
                            return '众泰专营店'+a[1]
                        } else if (shop_id == '1584616501') {
                            return '易加'+a[1]
                        }
                        
                    } else {
                        return ''
                    }
                },
                filterItems () {
                    return this.trades.filter((item) => {
                        var self = this
                        function fi(key) {
                            return item[key].match(self.search)
                        }
                        return fi('id') || fi('price') || fi('nick') || fi('wuliu') || fi('createTime') || fi('status') || fi('shop');
                    });
                }
            },
            created () {
                this.init();
                $('#btn2').hide()
            },
            methods: {
                init () {
                    if (!localStorage.getItem('cookie')) localStorage.setItem('cookie', '');
                    if (!localStorage.getItem('names')) localStorage.setItem('names', '');
                    if (!localStorage.getItem('names2')) localStorage.setItem('names2', '');
                    this.cookie = localStorage.getItem('cookie');
                    this.names = localStorage.getItem('names');
                    this.names2 = localStorage.getItem('names2');
                    url = '/api/trades'
                    fetch(url+ '?page_size=' + this.page_size)
                    .then(resp => resp.json())
                    .then(data => {
                        this.trades = data.trades;
                        console.log(this.trades)
                    })
                },
                post_trades () {
                    localStorage.setItem('cookie', this.cookie);
                    localStorage.setItem('names', this.names);
                    localStorage.setItem('names2', this.names2);
                    var data = {'names': this.names + '\n' + this.names2, 
                        'cookie': this.parse_cookie, 'pageNum': this.pageNum,
                        'start': this.value[0], 'end': this.value[1],
                        'userAgent': navigator.userAgent
                        }
                    var url = '/api/trades'
                    if (this.cookie!='' & (this.names!='' | this.names2!='')) {
                        fetch(url, {
                            method: 'POST', // or 'PUT'
                            body: JSON.stringify(data), // data can be `string` or {object}!
                            headers: new Headers({
                                'Content-Type': 'application/json'
                            })
                            }).then(res => res.json())
                            .catch(error => console.log('Error:', error))
                            .then(response => {
                                console.log('Success:', response);
                                this.init();
                            });
                    } else {
                        this.init();
                    }
                },
                reset () {
                    this.names = '';
                },
                reset1 () {
                    this.cookie = '';
                },
                filterShop (shop_id) {
                    if (shop_id === '3079394145') {
                        return '通众旗舰店'
                    } else if (shop_id == '2933051711') {
                        return '亿维办公旗舰店'
                    } else if (shop_id == '925025092') {
                        return '亿维通众专卖店'
                    } else if (shop_id == '2829884134') {
                        return '众泰专营店'
                    } else if (shop_id == '1584616501') {
                        return '易加'
                    }
                },
                kd(kd) {
                    this.search = kd
                },
                del_trade(trade) {
                    fetch('/api/trades/' + trade.id + '/delete', {
                        method: 'POST',
                        headers: new Headers({
                            'Content-Type': 'application/json'
                        })
                    }).then(res => res.json())
                    .catch(error => console.log('Error:', error))
                    .then(response => {
                        this.trades = this.trades.filter(trade => {
                            return trade.id != response.id;
                        })
                    });
                },
                parse_shop_id () {
                    var re = /x=(\w+)/;
                    var a = re.exec(this.cookie);
                    return a[1]
                },
                clear () {
                    this.names3 = this.names
                    this.names = this.names2
                    this.names2 = ''
                    $('#btn1').hide()
                    $('#btn2').show()
                },
                clear2 () {
                    this.names2 = this.names
                    this.names = this.names3
                    this.name3 = ''
                    $('#btn2').hide()
                    $('#btn1').show()
                }
            }
        })
        $(function() {
            setInterval(function () {
                var now = new Date();
                var hour = now.getHours();
                if (hour < 24 & hour > 9) {
                    app.post_trades();
                    console.log('sleep 9 min')
                }
            } , parseInt(1000*60*(Math.random()+9)))
            
            setInterval(function () {
                app.value = [moment().subtract(2, 'days'), moment()]
            }, 1000)
        })
    </script>
{% endblock %}

{% block footer %}
{% endblock %}
